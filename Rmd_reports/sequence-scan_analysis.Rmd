---
author: "Jacques van Helden"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    self_contained: no
    fig_caption: yes
    highlight: tango
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  ioslides_presentation:
    slide_level: 2
    self_contained: no
    colortheme: dolphin
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    fonttheme: structurebold
    highlight: tango
    smaller: yes
    toc: yes
    widescreen: yes
  revealjs::revealjs_presentation:
    theme: night
    transition: none
    self_contained: true
    css: ../../slides.css
  slidy_presentation:
    smart: no
    slide_level: 2
    self_contained: yes
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    highlight: tango
    incremental: no
    keep_md: yes
    smaller: yes
    theme: cerulean
    toc: yes
    widescreen: yes
  pdf_document:
    fig_caption: yes
    highlight: zenburn
    toc: yes
    toc_depth: 3
  beamer_presentation:
    colortheme: dolphin
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    fonttheme: structurebold
    highlight: tango
    incremental: no
    keep_tex: no
    slide_level: 2
    theme: Montpellier
    toc: yes
font-import: http://fonts.googleapis.com/css?family=Risque
title: Analysis of sequence scanning results
subtitle: IBIS challenge 2024
font-family: Garamond
transition: linear
editor_options: 
  chunk_output_type: console
---

```{r setup, eval=TRUE, echo=FALSE, include=FALSE}
library(knitr)
library(kableExtra)
library(rprojroot)
library(data.table)
# library(formattable)

root_dir = rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir = root_dir)
#setwd(root_dir)

# options(encoding = 'UTF-8')
knitr::opts_chunk$set(
	eval = TRUE,
	echo = TRUE,
	fig.align = "center",
	fig.height = 5,
	fig.path = "figures/PBM_",
	fig.width = 7,
	message = FALSE,
	warning = FALSE,
	comment = "",
	results = TRUE,
	root.dir = root_dir,
	size = "tiny"
)
options(scipen = 12) ## Max number of digits for non-scientific notation
# knitr::asis_output("\\footnotesize")

options(width = 300)
# options(encoding = 'UTF-8')

# getwd()
```

```{r param}
#### Define default parameters ####
board <- 'leaderboard'
experiment <- "CHS"
tf <- "GABPA"
dataset <- "THC_0866" 
```

## Metadata

```{r load_metadata}
## Load metadata
metadata_file <- file.path("metadata", board, "TF_DATASET_all-types.tsv")
setwd(root_dir)
# getwd()
metadata <- read.table(metadata_file, header = TRUE, sep="\t", comment.char = "")
colnames(metadata)[1] <- "TF"
rownames(metadata) <- metadata$DATASET
# View(metadata)

TFS <- unique(metadata$TF)
datasets <- unique(metadata$DATASET)
experiments <- unique(metadata$EXPERIMENT)

```

```{r metadata_summary}
metadata_summary <- table(metadata[, c("TF", "EXPERIMENT")])
metadata_summary <- cbind(metadata_summary, total=apply(metadata_summary, 1, sum))
metadata_summary <- metadata_summary[order(metadata_summary[, "total"], decreasing = TRUE), ]
kable(metadata_summary, caption="Summary of the metadata. Number of datasets per transcription factor (rows) and experiment (colums)")
```


## Datasets

- **PCM:** we scanned sequences with position-count matrices (PCM) resulting from motif discovery in in train sequence sets. Motif discovery was performed with  `peak-motifs`  using 3 algorithms: `oligo-analysis`, `dyad-analysis` and `position-analysis`. 

- **sequences:** we scan three types of sequence sets. 

    - **train:** training sequences. Note that for PBM the training sequences are the 500 spots having the highest signal intensity, whereas for other experiments (CHS, GHTS, HTS, SMS) the train sequences are all the sequences downloaded from the IBIS web site ([leaderboard](https://ibis.autosome.org/download_data/leaderboard) or [final](https://ibis.autosome.org/download_data/final)).  

    - **rand:** random genome fragments of the same sizes as the train sequences (see previous section)

    - **test:** test sequences downloaded from the IBIS web site ([leaderboard](https://ibis.autosome.org/download_data/leaderboard) or [final](https://ibis.autosome.org/download_data/final)).  


```{r load_data}

#### Load data table (sequence scanning results)


## Initialize variables
TF <- metadata[dataset, "TF"]
experiment <- metadata[dataset, "EXPERIMENT"]
seq_type <- "train"
seq_types <- c("train", "rand", "test")
seq_types <- c("train", "rand")
top_hits <- list()

scan_dir <- file.path("results", 
                      board,
                      "train", 
                      experiment, 
                      TF, 
                      dataset, "peak-motifs-nopurge", "clustered_motifs", "", "matrix-clusters_aligned_logos", "All_concatenated_motifs_trimmed-info_0.1", "sequence-scan")

message(paste(collapse="\t", "Reading sequence scan tables", dataset, TF, experiment))
message("\t", scan_dir)
## Read the data tables for the different sequence types
for (seq_type in seq_types) {
  scan_file <- file.path(scan_dir, 
                       paste0(experiment, "_",
                              TF, "_",
                              dataset, 
                              "_peakmo-clust-matrices_", 
                              seq_type,
                              ".tsv.gz"))
  
  message("\t", seq_type, "\t", basename(scan_file))

  system.time(top_hits[[seq_type]] <- 
                data.table::fread(
                  cmd = paste0("zless ", scan_file, " | grep -v '^;' "), 
                  sep = "\t", 
                  header = TRUE, 
                  stringsAsFactors = FALSE, 
                  select = c(1, 3:6, 8),
                  showProgress = TRUE))
  top_hits[[seq_type]]$seq_type <- seq_type
  
  ## View(top_hits[[seq_type]])
}


merged <- rbind(top_hits[["train"]], 
                top_hits[["rand"]]) # merge train and rand
merged <- merged[order(merged$weight, decreasing = TRUE), ]
motifs <- unique(merged$ft_name)
nmotifs <- length(motifs)

#### Compute statistics for each motif #### 
stat_per_motif <- list()
motif <- motifs[1]
for (motif in motifs) {
  stats <- merged[merged$ft_name == motif, ]
  npos <- sum(stats$seq_type == "train") # number of positive cases
  nneg <- sum(stats$seq_type == "rand")  # number of negative cases
  # View(stats)
  # head(stats)
  # tail(stats)
  stats$rank <- 1:nrow(stats)
  stats$TP <- cumsum(stats$seq_type == "train")
  stats$FP <- cumsum(stats$seq_type == "rand")
  stats$FN <- npos - stats$TP
  stats$TN <- nneg - stats$FP
  
  ## TPR = Sn = coverage
  stats$TPR <- stats$TP / (stats$TP + stats$FN)
  
  ## TPR
  stats$FPR <- stats$FP / (stats$FP + stats$TN)
  
  stats$Sn <- stats$TP / npos
  stat_per_motif[[motif]] <- stats 
}  
  
```


```{r ROC}

motif <- motifs[1]
stats <- stat_per_motif[[motif]]
plot(stats$FPR, 
     xlab = "FPR", 
     xlim = c(0,1),
     
     stats$TPR, 
     ylab = "TPR (Sn)",
     ylim = c(0,1),
     
     main = paste0(experiment, " ", TF, " ", dataset, "\nROC"),
     
     type = "l",
     col = 1,
     las = 1,
     panel.first = c(
       abline(h=seq(0, 1, 0.1), col="#DDDDDD"),
       abline(v=seq(0, 1, 0.1), col="#DDDDDD")
       )
     )

abline(a = 0, b = 1, col = "black")
abline(v = c(0, 1), col = "black")
abline(h = c(0, 1), col = "black")

for (i in 2:nmotifs) {
  motif <- motifs[[i]]
  stats <- stat_per_motif[[i]]
  lines(stats$FPR,
        stats$TPR, 
        col = i)
}

legend("bottomright", legend = motifs, col = 1:nmotifs, lwd=2, cex=0.7)

```

